---
title: "Le vote des quartiers politiques de la ville de la Métropole de Lyon"
subtitle: "Analyse des élections législatives et présidentielles de 2017 et 2022"
author: "Datactivist"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      #self_contained: false
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: !expr here::here("préparation/styles.css")
      includes:
        in_header: !expr here::here("préparation/header.html")
        after_body: !expr here::here("préparation/footer.html")
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"#,
	#cache = TRUE
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Préambule


```{r libraries et données, include=FALSE}
# Librairies
library(sf)
library(here)
library(gridExtra)
#remotes::install_github("r-spatial/mapview", dependencies = TRUE)
library(mapview)
library(leafpop)
library(leafsync)
library(ggtext)
library(tools)
library(RColorBrewer)
library(tidyverse)
library(FactoMineR)
library(factoextra)
library(corrplot)

# Données
bv_2017 <- st_read(here("output_data", "bv_2017.gpkg"))
bv_communes_2022 <- st_read(here("output_data", "bv_communes_2022.gpkg"))

bv_l17_t1 <- st_read(here("output_data", "bv_grandlyon_l2017_t1_res.gpkg")) |> mutate(id=NA)
bv_l22_t1 <- st_read(here("output_data", "bv_grandlyon_l2022_t1_res.gpkg"))
bv_p17_t1 <- st_read(here("output_data", "bv_grandlyon_p2017_t1_res.gpkg")) |> mutate(id=NA)
bv_p17_t2 <- st_read(here("output_data", "bv_grandlyon_p2017_t2_res.gpkg")) |> mutate(id=NA)
bv_p22_t1 <- st_read(here("output_data", "bv_grandlyon_p2022_t1_res.gpkg"))
bv_p22_t2 <- st_read(here("output_data", "bv_grandlyon_p2022_t2_res.gpkg"))

qpv_l17_t1 <- st_read(here("output_data", "qpv69_leg_17_t1.gpkg"))
qpv_l22_t1 <- st_read(here("output_data", "qpv69_leg_22_t1.gpkg"))
qpv_p17_t1 <- st_read(here("output_data", "qpv69_pres_17_t1.gpkg"))
qpv_p17_t2 <- st_read(here("output_data", "qpv69_pres_17_t2.gpkg"))
qpv_p22_t1 <- st_read(here("output_data", "qpv69_pre_22_t1.gpkg"))
qpv_p22_t2 <- st_read(here("output_data", "qpv69_pre_22_t2.gpkg"))
```

## Localisation des BV

```{r évolution des BV}
# Jointure des 2 bases pour voir les différences
evolution_bv <- full_join(bv_2017 |> as.data.frame() |> 
                              mutate(annee = "2017",
                                     real_id_2017 = bureau_vote_id,
                                     bureau_vote_id = case_when(substr(bureau_vote_id, 1, 4) == "6938" ~ paste0("69123", substr(bureau_vote_id, 6, 9)),
                                                                .default = bureau_vote_id)),
                          bv_communes_2022 |> as.data.frame() |> select(-c(type, id)) |> mutate(annee = "2022"), 
                          by = "bureau_vote_id", suffix = c("_2017", "_2022")) |>
    mutate(evol_bv = case_when(geom_2017 == geom_2022 ~ "Bureaux de votes identiques",
                               geom_2017 != geom_2022 ~ "Bureaux de votes redécoupés",
                               is.na(annee_2017) ~ "Bureaux de votes créés",
                               is.na(annee_2022) ~ "Bureaux de votes supprimés", 
                              .default = NA)) |> 
    select(-c(annee_2017, annee_2022)) 
evolution_bv <- evolution_bv |> 
  mutate(is_intersect = st_intersects(evolution_bv$geom_2017, qpv_p17_t1$geom, sparse = FALSE),
           is_intersect = asplit(is_intersect, 1)) |> 
    unnest_wider(c(is_intersect), names_sep = "_") |> 
    mutate(perim_met = case_when(if_any(contains("is_intersect"), function(x) {x == "TRUE"}) ~ "BV - QPV",
                                if_all(contains("is_intersect"), function(x) {x == "FALSE"}) ~ "BV")) |> 
    select(-starts_with("is_intersect"))
#table(evolution_bv$evol_bv)
evolution_bv_longer <- evolution_bv |> 
    pivot_longer(cols = c(geom_2017, geom_2022), values_to = "geom", names_prefix = "geom_", names_to = "annee") |> 
    mutate(evol_bv_neutre_2017 = case_when(annee == "2017" ~ "Bureaux de votes identiques",
                                           .default = evol_bv),
           evol_bv_neutre_2017 = factor(evol_bv_neutre_2017, 
                                        levels = c("Bureaux de votes identiques", "Bureaux de votes redécoupés", 
                                                "Bureaux de votes supprimés", "Bureaux de votes créés")))

# Visualisation des découpages 2017 vs. 2022
evolution_bv_longer |> 
    ggplot() +
        geom_sf(aes(geometry = geom, fill = evol_bv_neutre_2017)) +
        scale_fill_manual(values = c("Bureaux de votes identiques" = "wheat2", "Bureaux de votes redécoupés" = "wheat3", 
                                     "Bureaux de votes créés" = "brown3", "Bureaux de votes supprimés" = "#999999")) +
        labs(title = "Localisation des bureaux de votes de la métropole de Lyon", 
             subtitle = "Entre 2017 et 2022, 5 bureaux de vote (BV) sont restés parfaitement identiques, \n861 ont été redécoupés, 30 ont été créés et 1 a été supprimé.", 
             fill = "",
             caption = "Source: Données extraites des listes électorales et Cartelec, Céline COLANGE ©UMR CNRS 6266 IDEES, Université de Rouen \nRéalisation: Gombin J., Thierry D. Analyse du vote des QPV de la métropole de Lyon en 2017 et 2022") +
        facet_wrap(~annee) +
        theme_void() +
        guides(fill = guide_legend(override.aes = list(lwd = 1, col = "white"))) +
        theme(plot.title = element_text(face = "bold"),
              plot.caption = element_text(face = "italic", hjust = 0),
              strip.text = element_text(face = "bold", size = 12, margin = margin(20,0,0,0)))
# nom des comm de plus de 20.000 hab
# nombre d'inscrits / nombre d'habitants en âge de voter en popup -> Joël
```


```{r evol BV interactif}
# Même dataviz interactive
p2017 <- evolution_bv_longer |> 
    filter(annee == "2017") |> 
    st_as_sf() |> 
    mapview(zcol = "evol_bv_neutre_2017",
      layer.name = "Bureaux de votes en 2017",
      legend = FALSE, 
      basemaps.color.shuffle = FALSE, map.types = "CartoDB.Positron",
      col.regions = c("Bureaux de votes identiques" = "wheat2", "Bureaux de votes redécoupés" = "wheat3", 
                      "Bureaux de votes supprimés" = "#999999", "Bureaux de votes créés" = "brown3"),
      popup = popupTable(evolution_bv_longer, zcol = c("code_insee_2017")))
p2022 <- evolution_bv_longer |> 
    filter(annee == "2022") |> 
    st_as_sf() |> 
    mapview(zcol = "evol_bv_neutre_2017",
      layer.name = "Bureaux de votes en 2022",
      legend = TRUE, 
      basemaps.color.shuffle = FALSE, map.types = "CartoDB.Positron",
      col.regions = c("Bureaux de votes identiques" = "wheat2", "Bureaux de votes redécoupés" = "wheat3", 
                      "Bureaux de votes supprimés" = "#999999", "Bureaux de votes créés" = "brown3"),
      popup = popupTable(evolution_bv_longer, zcol = c("code_insee_2022")))
sync(p2017,p2022)
#p2017 | p2022
# titre, sous-titre, caption
# popup
```

`r nrow(bv_2017)` bureaux de vote en 2017 et `r nrow(bv_communes_2022)` en 2022, soit `r nrow(bv_communes_2022) - nrow(bv_2017)` de différence. 

## Contrôle du redécoupage des BV

```{r Inscrits BV 17-22, out.width='60%'}
# Nuage de points sur le nombre d'inscrits dans le BV 2017 et 2022
full_join(bv_p17_t1 |> as.data.frame(),
          bv_p22_t1 |> as.data.frame(), 
          by = "bureau_vote_id", suffix = c("_2017", "_2022")) |> 
  select(bureau_vote_id, Inscrits_2017, Inscrits_2022) |> 
  ggplot(aes(x = Inscrits_2017, y = Inscrits_2022)) +
  geom_point(alpha = .5) +
  geom_abline(col = "red") +
  labs(x = "Nombre d'inscrits en 2017", y = "Nombre d'inscrits en 2022",
       title = "Comparaison du nombre d'inscrits dans les bureaux de vote entre 2017 et 2022",
       subtitle = "Personnes inscrites au premier tour des élections présidentielles dans 2 années") +
  xlim(500,NA) + ylim(500,NA) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 1),
        plot.subtitle = element_text(face = "italic"))
```

```{r eval=FALSE, include=FALSE}
# Taux de superposition spatiale
  # Création d'objets vides
inter_bv <- 0
inter_save <- 0
area_commune <- 0
area_2017 <- 0
ratio <- 0
  # Calcul du ratio
for (i in 1:52) {
  evolution_bv_sf <- evolution_bv |> st_as_sf() |> filter(row_number() == i)
  inter_bv <- st_intersection(evolution_bv_sf$geom_2017, evolution_bv_sf$geom_2022)
  inter_save[i] <- inter_bv
  area_commune[i] <- st_area(inter_bv)
  area_2017[i] <- st_area(evolution_bv_sf$geom_2017)
  ratio[i] <- area_commune[i] / area_2017[i] *100
  inter_bv <- 0
}

evolution_bv_sf <- evolution_bv |> st_as_sf() |> filter(row_number() < 53)
inter_bv <- st_intersection(evolution_bv_sf$geom_2017, evolution_bv_sf$geom_2022)
plot(evolution_bv_sf$geom_2017, axes = TRUE)
plot(evolution_bv_sf$geom_2022, add = TRUE)
plot(inter_bv, add = TRUE, col = 'red')
# voir si QPV sont dans BV
# mapview des BV avec ratios < 97%
```


## Localisation des QPV

```{r localisation QPV, echo=FALSE}
# Prépa données
evolution_bv_qpv <- rbind(evolution_bv_longer |> filter(annee == "2017") |> rename(id = bureau_vote_id) |> 
                              mutate(type = "Bureaux de vote") |> select(id, type, annee, geom),
                          evolution_bv_longer |> filter(annee == "2022") |> rename(id = bureau_vote_id) |> 
                              mutate(type = "Bureaux de vote") |> select(id, type, annee, geom),
                          qpv_p17_t1 |> rename(id = CODE_QP) |> as.data.frame() |> 
                              mutate(type = "Quartiers prioritaires", annee = "2017") |> select(id, type, annee, geom),
                          qpv_p22_t1 |> rename(id = CODE_QP) |> as.data.frame() |> 
                              mutate(type = "Quartiers prioritaires", annee = "2022") |> select(id, type, annee, geom))

# Visualisation des QPV 2017 vs. 2022
# evolution_bv_qpv |> 
#     ggplot() +
#         geom_sf(aes(geometry = geom, fill = type)) +
#         scale_fill_manual(values = c("Bureaux de vote" = "wheat2", "Quartiers prioritaires" = "brown3")) +
#         labs(title = "Localisation des quartiers prioritaires de la ville de Lyon \nparmi les bureaux de vote", 
#              subtitle = "Le découpage des quartiers prioritaires n'a pas évolué entre 2017 et 2022.", fill = "",
#              caption = "Source: Données extraites des listes électorales et Cartelec, Céline COLANGE ©UMR CNRS 6266 IDEES, Université de Rouen \nRéalisation: Gombin J., Thierry D. Analyse du vote des QPV de la métropole de Lyon entre 2017 et 2022") +
#         facet_wrap(~annee) +
#         theme_void() +
#         guides(fill = guide_legend(override.aes = list(lwd = 1, col = "white"))) +
#         theme(plot.title = element_text(face = "bold"),
#               plot.caption = element_text(face = "italic", hjust = 0),
#               strip.text = element_text(face = "bold", size = 12, margin = margin(20,0,0,0)))
# version intéractive avec nb habitants et inscrits
p2017 <- evolution_bv_qpv |> 
    st_as_sf() |> 
    mapview(zcol = "type",
      layer.name = "Bureaux de votes en 2017",
      legend = FALSE, 
      basemaps.color.shuffle = FALSE, map.types = "CartoDB.Positron",
      col.regions = c("Bureaux de vote" = "wheat2", "Quartiers prioritaires" = "brown3"))
p2022 <- evolution_bv_qpv |> 
    st_as_sf() |> 
    mapview(zcol = "type",
      layer.name = "Bureaux de votes en 2022",
      legend = TRUE, 
      basemaps.color.shuffle = FALSE, map.types = "CartoDB.Positron",
      col.regions = c("Bureaux de vote" = "wheat2", "Quartiers prioritaires" = "brown3"))
sync(p2017,p2022)
```


<br>

<br>

## Population, inscrits, votants{.tabset}

```{r include=FALSE}
# Import données externes
pop_qpv <- st_read(here("output_data", "data_pop_qpv_2018.csv"))
pop_communes <- read_delim("https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/demographyref-france-pop-legale-commune-arrondissement-municipal/exports/csv?lang=fr&facet=facet(name%3D%22reg_code%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22reg_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22com_arm_code%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22com_arm_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22dep_code%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22arrdep_code%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22epci_name%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22epci_code%22%2C%20disjunctive%3Dtrue)&facet=facet(name%3D%22dep_name%22%2C%20disjunctive%3Dtrue)&refine=dep_code%3A%2269%22&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
  mutate(code_insee = as.character(`Code Officiel Commune / Arrondissement Municipal`)) |> 
  select(code_insee, `Population municipale`) |> 
  rename(Population = `Population municipale`)
```


### BV

```{r pop BV, fig.height=7}
rbind(bv_l17_t1 |> 
        mutate(type = "Législatives 2017 tour 1", Population = 1386000) |> 
        select(code_insee, Population, Inscrits, Votants, type),
      bv_l22_t1 |> 
        mutate(type = "Législatives 2022 tour 1", Population = 1411570) |> 
        select(code_insee, Population, Inscrits, Votants, type),
      bv_p17_t1 |> 
        mutate(type = "Présidentielles 2017 tour 1", Population = 1386000) |> 
        select(code_insee, Population, Inscrits, Votants, type),
      bv_p22_t1 |> 
        mutate(type = "Présidentielles 2022 tour 1", Population = 1411570) |> 
        select(code_insee, Population, Inscrits, Votants, type),
      bv_p17_t2 |> 
        mutate(type = "Présidentielles 2017 tour 2", Population = 1386000) |> 
        select(code_insee, Population, Inscrits, Votants, type),
      bv_p22_t2 |> 
        mutate(type = "Présidentielles 2022 tour 2", Population = 1411570) |> 
        select(code_insee, Population, Inscrits, Votants, type)) |> 
  group_by(type) |> 
  mutate(Inscrits = sum(Inscrits, na.rm = T),
         Votants = sum(Votants, na.rm = T)) |> 
  as.data.frame() |> 
  select(-c(code_insee, geom)) |> 
  distinct() |> 
  mutate(total = Population) |> 
  pivot_longer(cols = -c(type, total), names_to = "compte", values_to = "nb") |> 
  mutate(percent = paste0(round(nb/total*100, 0), "%"),
         compte = fct_reorder(compte, nb, .desc = TRUE)) |> 
  ggplot(aes(x = compte, y = nb, group = type)) +
    geom_bar(stat = "identity", width = .6, fill = "wheat2", color = "black") +
    labs(x = "", y = "Nombre de personnes", 
         title = "Répartition des votants et inscrits parmi la population \n(en 2017 et 2022) des communes des bureaux de vote") +
    theme_classic() +
    theme(legend.position = "none",
          text = element_text(family = "Monsterrat", size = 12),
          plot.title = element_text(face = "bold"),
          axis.title.y = element_blank(),
          panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
          axis.line.y = element_blank(),
          axis.ticks.y = element_blank()) +
    geom_text(aes(y = nb + 0.1*max(nb), x = compte, label = percent), 
              color = "#333333", size = 3, check_overlap = T) +
    facet_wrap(~type, ncol = 2, scales='free') +
    scale_y_continuous(labels = scales::comma)
```


### QPV

```{r pop QPV, fig.height=7}
# QPV
rbind(qpv_l17_t1 |> 
        left_join(pop_qpv |> select(codeQPV, popMuniQPV),
                          by = c("CODE_QP" = "codeQPV")) |> 
        select(CODE_QP, popMuniQPV, Inscrits, Votants) |> 
        mutate(type = "Législatives 2017 tour 1") |> 
        rename(id = CODE_QP, Population = popMuniQPV), 
      qpv_l22_t1 |> 
        left_join(pop_qpv |> select(codeQPV, popMuniQPV),
                          by = c("CODE_QP" = "codeQPV")) |> 
        select(CODE_QP, popMuniQPV, Inscrits, Votants) |> 
        mutate(type = "Législatives 2022 tour 1") |> 
        rename(id = CODE_QP, Population = popMuniQPV),
      qpv_p17_t1 |> 
        left_join(pop_qpv |> select(codeQPV, popMuniQPV),
                          by = c("CODE_QP" = "codeQPV")) |> 
        select(CODE_QP, popMuniQPV, Inscrits, Votants) |> 
        mutate(type = "Présidentielles 2017 tour 1") |> 
        rename(id = CODE_QP, Population = popMuniQPV),
      qpv_p22_t1 |> 
        left_join(pop_qpv |> select(codeQPV, popMuniQPV),
                          by = c("CODE_QP" = "codeQPV")) |> 
        select(CODE_QP, popMuniQPV, Inscrits, Votants) |> 
        mutate(type = "Présidentielles 2022 tour 1") |> 
        rename(id = CODE_QP, Population = popMuniQPV),
      qpv_p17_t2 |> 
        left_join(pop_qpv |> select(codeQPV, popMuniQPV),
                          by = c("CODE_QP" = "codeQPV")) |> 
        select(CODE_QP, popMuniQPV, Inscrits, Votants) |> 
        mutate(type = "Présidentielles 2017 tour 2") |> 
        rename(id = CODE_QP, Population = popMuniQPV),
      qpv_p22_t2 |> 
        left_join(pop_qpv |> select(codeQPV, popMuniQPV),
                          by = c("CODE_QP" = "codeQPV")) |> 
        select(CODE_QP, popMuniQPV, Inscrits, Votants) |> 
        mutate(type = "Présidentielles 2022 tour 2") |> 
        rename(id = CODE_QP, Population = popMuniQPV)) |> 
  group_by(type) |> 
  mutate(Population = sum(as.numeric(Population), na.rm = T),
         Inscrits = sum(Inscrits, na.rm = T),
         Votants = sum(Votants, na.rm = T)) |> 
  as.data.frame() |> 
  select(-c(id, geom)) |> 
  distinct() |> 
  mutate(total = Population) |> 
  pivot_longer(cols = -c(type, total), names_to = "compte", values_to = "nb") |> 
  mutate(percent = paste0(round(nb/total*100, 0), "%"),
         compte = fct_reorder(compte, nb, .desc = TRUE)) |> 
  ggplot(aes(x = compte, y = nb, group = type)) +
    geom_bar(stat = "identity", width = .6, fill = "brown3", color = "black") +
    labs(x = "", y = "Nombre de personnes", 
         title = "Répartition des votants et inscrits parmi la population \n(en 2018) des quartiers prioritaires") +
    theme_classic() +
    theme(legend.position = "none",
          text = element_text(family = "Monsterrat", size = 12),
          plot.title = element_text(face = "bold"),
          axis.title.y = element_blank(),
          panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
          axis.line.y = element_blank(),
          axis.ticks.y = element_blank()) +
    geom_text(aes(y = nb + 0.1*max(nb), x = compte, label = percent), 
              color = "#333333", size = 3, check_overlap = T) +
    facet_wrap(~type, ncol = 2, scales='free') +
    scale_y_continuous(labels = scales::comma)
```


# Présentation des données

## Distribution des votes{.tabset}

```{r function violinplot}
violinplot_comp <- function(bv, qpv, elections, interpretation, min_x, max_x){
    common_cols <- intersect(colnames(bv), colnames(qpv))
    bv <- bv |> left_join(evolution_bv |> select(bureau_vote_id, perim_met), by = 'bureau_vote_id')
    bv_all <- bv |> as.data.frame() |> rename(old_id = id, id = bureau_vote_id) |> 
      select(id, common_cols, -ends_with(c(".ins", ".exp"))) |> mutate(type = "Ensemble métropole") |> select(-geom)
    bv_hors_qpv <- bv |> as.data.frame() |> filter(perim_met != "BV - QPV") |> rename(old_id = id, id = bureau_vote_id) |> 
      select(id, common_cols, -ends_with(c(".ins", ".exp"))) |> mutate(type = "Métropole hors QPV") |> select(-geom)
    qpv <- qpv |> as.data.frame() |> rename(id = CODE_QP) |> select(id, common_cols, -ends_with(c(".ins", ".exp"))) |> 
      mutate(type = "Quartiers prioritaires") |> select(-geom)
    rbind(bv_all, bv_hors_qpv, qpv)|> 
        pivot_longer(cols = -c(id, type, Inscrits), values_to = "nb_pers", names_to = "vote") |> 
        mutate(percent_inscrits = nb_pers/Inscrits*100,
               order_false_percent = case_when(vote == "Abstentions" ~ 150,
                                               vote == "Blancs" ~ 125,
                                               vote == "Nuls" ~ 100,
                                               .default = percent_inscrits),
               vote = str_replace_all(vote, "\\.", " "),
               # vote = toTitleCase(tolower(vote)),
               vote = fct_reorder(vote, order_false_percent, .desc = T)) |> 
        filter(!vote %in% c("Votants", "Exprimés")) |>
        ggplot(aes(x = type, y = percent_inscrits, fill = type)) +
            geom_violin(linewidth = .3) +
            #geom_jitter(shape=16, position=position_jitter(0.2), alpha = .1) +
            facet_wrap(~vote, scales='free_x') +
            scale_y_continuous(limits=c(min_x, max_x)) +
            scale_fill_manual(values = c("Ensemble métropole" = "wheat3", "Métropole hors QPV" = "wheat2", 
                                         "Quartiers prioritaires" = "brown3")) +
            labs(title = paste0("Comparaison de la distribution des votes entre BV et QPV \n", elections), 
                 subtitle = interpretation, fill = "",
                 caption = "Source: Données extraites des listes électorales et Cartelec, \nCéline COLANGE ©UMR CNRS 6266 IDEES, Université de Rouen \nRéalisation: Gombin J., Thierry D. Analyse du vote des QPV de la métropole de Lyon en 2017 et 2022",
                 y = "Pourcentage d'inscrits", x = "Vote") +
            coord_flip() +
            theme_classic() +
            theme(plot.title = element_text(face = "bold"),
                  plot.caption = element_text(face = "italic", hjust = 0),
                  strip.text = element_text(color = "black", face = "bold"),
                  legend.position = "none",
                  axis.title.y = element_blank(),
                  panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
                  axis.line.y = element_blank(),
                  axis.ticks.y = element_blank())
}
```

### Pres.17 tour 1

```{r fig.height=10}
violinplot_comp(bv_p17_t1, qpv_p17_t1, "au premier tour des présidentielles de 2017", "", 0, 50)
```

### Pres.17 tour 2

```{r fig.height=5}
violinplot_comp(bv_p17_t2, qpv_p17_t2, "au second tour des présidentielles de 2017", "", 0, 60)
```

### Leg.17 tour 1

```{r fig.height=10}
violinplot_comp(bv_l17_t1, qpv_l17_t1, "au premier tour des législatives de 2017", "", 0, 80)
```


### Pres.22 tour 1

```{r fig.height=10}
violinplot_comp(bv_p22_t1, qpv_p22_t1, "au premier tour des présidentielles de 2022", "", 0, 80)
```

### Pres.22 tour 2

```{r fig.height=5}
violinplot_comp(bv_p22_t2, qpv_p22_t2, "au second tour des présidentielles de 2022", "", 0, 80)
```

### Leg.22 tour 1

```{r fig.height=10}
violinplot_comp(bv_l22_t1, qpv_l22_t1, "au premier tour des législatives de 2017", "", 0, 80)
```




## Cartographies des votes{.tabset}

### Pres.17 tour 1

<iframe src="Save_cartos/carte_p17_t1.html" height="600" width="1000" style="border: 0px solid #464646;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>


### Pres.17 tour 2

<iframe src="Save_cartos/carte_p17_t2.html" height="600" width="1000" style="border: 0px solid #464646;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>


### Leg.17 tour 1

<iframe src="Save_cartos/carte_l17_t1.html" height="600" width="1000" style="border: 0px solid #464646;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>


### Pres.22 tour 1

<iframe src="Save_cartos/carte_p22_t1.html" height="600" width="1000" style="border: 0px solid #464646;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>


### Pres.22 tour 2

<iframe src="Save_cartos/carte_p22_t2.html" height="600" width="1000" style="border: 0px solid #464646;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>


### Leg.22 tour 1

<iframe src="Save_cartos/carte_l22_t1.html" height="600" width="1000" style="border: 0px solid #464646;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>




# Analyse en composantes principales

```{r code ACP}
#- ACP avec en 
#- individus actifs : les BV en 2017 
    #variables actives : les résultats pour P17T1, P17T2 
    #variables supplémentaires: les résultats pour L17T1, P22T1, P22T2, L22T1
#- individus supplémentaires : les BV 2022 et les QPV (2017 et 2022)
 #(éventuellement en pondérant les individus statistiques par le nombre d'inscrits, mais ça ne devrait pas changer grand chose)


# Préparation des données
var_actives <- left_join(as.data.frame(bv_p17_t1) |> rename_at(vars(-bureau_vote_id), ~ paste0(., '_p17_t1')), 
                         as.data.frame(bv_p17_t2) |> rename_at(vars(-bureau_vote_id), ~ paste0(., '_p17_t2')), 
                         by = 'bureau_vote_id') 
var_supp_pre <- left_join(as.data.frame(bv_p22_t1) |> rename_at(vars(-bureau_vote_id), ~ paste0(., '_p22_t1')), 
                          as.data.frame(bv_p22_t2) |> rename_at(vars(-bureau_vote_id), ~ paste0(., '_p22_t2')), 
                          by = 'bureau_vote_id')
var_supp_leg <- left_join(as.data.frame(bv_l17_t1) |> rename_at(vars(-bureau_vote_id), ~ paste0(., '_l17_t1')), 
                          as.data.frame(bv_l22_t1) |> rename_at(vars(-bureau_vote_id), ~ paste0(., '_l22_t1')), 
                          by = 'bureau_vote_id')
var_supp <- full_join(var_supp_pre, var_supp_leg, by = 'bureau_vote_id')
var_acp <- full_join(var_actives, var_supp, by = 'bureau_vote_id') |> 
    select(-starts_with(c("code_insee", "CodeInsee", "CodeDepartement", "Département", "CodeCirco", "Commune", "NumeroBV", "geom", "id_", "Code.du.département", "type", "Code.de.la.circonscription", "Code.de.la.commune", "Code.du.b.vote", "NbCand", "NumeroCirco", "CodeCommune")), 
           -contains(c("_ins", "_vot_", ".ins", ".exp")),
           -bureau_vote_id)

# ACP sans variables quanti supp
var_acp_sans_sup <- var_acp |> select(1:25)
res.pca <- PCA(var_acp_sans_sup, graph=FALSE)
```

#### Variance expliquée

```{r variance, out.width='60%'}
    # Scree plot
fviz_screeplot(res.pca, addlabels = TRUE, ylim = c (0, 45))
var <- get_pca_var(res.pca)
```

#### Variables{.tabset}

##### Dimensions 1 et 2

```{r}
fviz_pca_var(res.pca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             ggtheme = theme_minimal())
```


##### Dimensions 1 et 3

```{r}
fviz_pca_var(res.pca, col.var = "cos2",
             axes = c(1, 3),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             ggtheme = theme_minimal())
```


#### Qualité de représentation (cosinus carrés){.tabset}

```{r cos2}
#les variables sont biens représentées par chaque axe
corrplot(var$cos2, is.corr=FALSE)
```


##### Dimension 1

```{r cos2.1, out.width='60%'}
fviz_cos2(res.pca, choice = "var", axes = 1, top = 15)
```

##### Dimension 2


```{r cos2.2, out.width='60%'}
fviz_cos2(res.pca, choice = "var", axes = 2, top = 15)
```

##### Dimension 3

```{r cos2.3, out.width='60%'}
fviz_cos2(res.pca, choice = "var", axes = 3, top = 15)
```



#### Contribution des variables aux dimensions{.tabset}
 
```{r contrib}
# contribution de chaque variable à la formation des axes 1 et 2 
corrplot(var$contrib, is.corr=FALSE)    
```

##### Dimension 1

```{r contrib.1, out.width='60%'}
fviz_contrib(res.pca, choice = "var", axes = 1, top = 15)
```

##### Dimension 2


```{r contrib.2, out.width='60%'}
fviz_contrib(res.pca, choice = "var", axes = 2, top = 15)
```

##### Dimension 3

```{r contrib.3, out.width='60%'}
fviz_contrib(res.pca, choice = "var", axes = 3, top = 15)
```



#### Description des dimensions{.tabset}

##### Dimension 1

```{r dimdesc.1}
res.desc <- dimdesc(res.pca, axes = c(1,2,3))
as.data.frame(res.desc$Dim.1) |> rownames_to_column() |> na.omit() |> gt::gt()
```

##### Dimension 2


```{r dimdesc.2}
as.data.frame(res.desc$Dim.2) |> rownames_to_column() |> na.omit() |> gt::gt()
```

##### Dimension 3

```{r dimdesc.3}
as.data.frame(res.desc$Dim.3) |> rownames_to_column() |> na.omit() |> gt::gt()
```



#### Projection des individus{.tabset}

##### Dimensions 1 et 2

```{r individus, out.width='60%'}
fviz_pca_ind(res.pca, col.ind = "cos2", 
             axes = c(1, 2),
             label = "none", #masquer le texte des individus
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)
```


##### Dimensions 1 et 3

```{r, out.width='60%'}
fviz_pca_ind(res.pca, col.ind = "cos2", 
             axes = c(1, 3),
             label = "none", #masquer le texte des individus
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)
```

##### Variables et individus

```{r biplot}
fviz_pca_biplot(res.pca, repel = TRUE,
                label = "var", #masquer le texte des individus
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )
```


#### Clusters de variables

```{r}
# Kmeans
    # Preparation
set.seed(123)
res.km <- kmeans(var$coord, centers = 3, nstart = 25)
grp <- as.factor(res.km$cluster)
    # Color variables by groups
fviz_pca_var(res.pca, col.var = grp, 
             palette = c("#0073C2FF", "#EFC000FF", "#868686FF"),
             legend.title = "Cluster")
```

#### Variables supplémentaires

```{r quanti.sup}
res.pca_quanti.sup <- PCA(var_acp, quanti.sup=26:97, graph=FALSE)
    #graph
fviz_pca_var(res.pca_quanti.sup,
             col.var = "black",     # Active variables
             col.quanti.sup = "red" # Suppl. quantitative variables
             )
```

#### Individus supplémentaires{.tabset}

```{r ind.sup prepa}
# Préparation des données
var_actives_qpv <- left_join(as.data.frame(qpv_p17_t1) |> rename_at(vars(-CODE_QP), ~ paste0(., '_p17_t1')), 
                         as.data.frame(qpv_p17_t2) |> rename_at(vars(-CODE_QP), ~ paste0(., '_p17_t2')), 
                         by = 'CODE_QP') 
var_supp_pre_qpv <- left_join(as.data.frame(qpv_p22_t1) |> rename_at(vars(-CODE_QP), ~ paste0(., '_p22_t1')), 
                          as.data.frame(qpv_p22_t2) |> rename_at(vars(-CODE_QP), ~ paste0(., '_p22_t2')), 
                          by = 'CODE_QP')
var_supp_leg_qpv <- left_join(as.data.frame(qpv_l17_t1) |> rename_at(vars(-CODE_QP), ~ paste0(., '_l17_t1')), 
                          as.data.frame(qpv_l22_t1) |> rename_at(vars(-CODE_QP), ~ paste0(., '_l22_t1')), 
                          by = 'CODE_QP')
var_supp_qpv <- full_join(var_supp_pre_qpv, var_supp_leg_qpv, by = 'CODE_QP')
var_acp_qpv <- full_join(var_actives_qpv, var_supp_qpv, by = 'CODE_QP') |> 
    select(-starts_with(c("code_insee", "CodeInsee", "CodeDepartement", "Département", "CodeCirco", "Commune", "Numeroqpv", "geom", "id_", "Code.du.département", "type", "Code.de.la.circonscription", "Code.de.la.commune", "Code.du.b.vote", "NbCand", "NumeroCirco", "CodeCommune")), 
           -contains(c("_ins", "_vot_", ".ins", ".exp")),
           -CODE_QP)
ensemble <- rbind(var_acp |> mutate(type = "BV"),
                  var_acp_qpv |> mutate(type = "QPV"))
```

##### Dimensions 1 et 2

```{r}
res.pca_ind.sup <- PCA(ensemble[,-98], ind.sup=889:926, quanti.sup=26:97, graph=T, axes = c(1, 2))
```

##### Dimensions 1 et 3

```{r}
# ACP en intégrant les QPV en individus supplémentaires
res.pca_ind.sup <- PCA(ensemble[,-98], ind.sup=889:926, quanti.sup=26:97, graph=T, axes = c(1, 3))
```

##### Couleurs par type

```{r}
res.pca_all <- PCA(ensemble[,-98], graph = FALSE)
fviz_pca_ind(res.pca_all,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = ensemble$type, # color by groups
             palette = c("#00AFBB", "#E7B800"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups")
```


```{r}
#- comparaison de la distribution du vote pour chaque comportement principal par BV entre l'ensemble des BV de la Métropole et les QPV (avec `geom_dotplot` par exemple)

# Evolution du vote au sein des QPV

#- graphique avec en abscisse 4 scrutins (P17T1, L17T1, P22T1, L22T1) et en ordonnée le vote, et une ligne par grand comportement électoral (ou alors un graphique par comportement électoral, avec `geom_facet`, ce qui permet de rajouter en repère le comportement national et celui de l'ensemble de la Métropole de Lyon) 
```





